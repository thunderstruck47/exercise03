{% import "bootstrap/utils.html" as utils %}
{% import "bootstrap/wtf.html" as wtf %}
{% extends "base.html" %}
{% block title %}Order Payment{% endblock %}
{% block body %}
<div class="content-section">
  <br/>
    {{ utils.flashed_messages() }}
  <br/>
  <h1 style="text-align:center;">Finalize</h1>
  <hr class="intro-divider">
  <br/>
  <div class="center">
      <h4>Your order</h4>
        {% if products %}
        </br>
        <table class="table table-responsive">
          <thead>
            <tr>
              <th width="25%"> Image </th>
              <th width="25%"> Name </th>
              <th width="25%"> Quantity </th>
              <th width="25%"> Price </th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            <tr>
              <td><img src="{{ url_for('static', filename='uploads/' + product.main_image) if product.main_image }}" style="max-width:100%" alt="{{ product.name }} Main Image"></td>
              <td>{{ product.name }}</td>
              <td>{{ product.quantity }}</td>
              <td>{{ product.price }}&#x20AC;</td>  
            </tr>
            {% endfor %}
            <tr>
              <td></td>
              <td></td>
              <td>Subtotal:</td>
              <td>{{ total }}&#x20AC;</td>
           </tr>
         </tbody>
       </table>
     {% else %}
       <div style="text-align: center">
         <h4> You have no products to order. </h4>
         <hr class="intro-divider">
       </div>
     {% endif %} 
     </br>
     <script src="https://www.paypalobjects.com/api/checkout.js"></script>
     <div id="paypal-button-container" style="width:100%;"></div>
    </div>
</div>
<script>
    // Render the PayPal button
    paypal.Button.render({
        // Set your environment
        env: 'sandbox', // sandbox | production
        // Specify the style of the button
        style: {
            label: 'pay', // checkout | credit | pay
            size:  'responsive',    // small | medium | responsive
            shape: 'rect',     // pill | rect
            color: 'blue'      // gold | blue | silver
        },
        // Show the buyer a 'Pay Now' button in the checkout flow
            commit: true,

            // payment() is called when the button is clicked
            payment: function() {

                // Set up a url on your server to create the payment
                var CREATE_URL = "{{ url_for('payment.create')}}";

                // Make a call to your server to set up the payment
                return paypal.request.post(CREATE_URL)
                    .then(function(res) {
                        return res.paymentID;
                    });
            },

            // onAuthorize() is called when the buyer approves the payment
            onAuthorize: function(data, actions) {
                console.log(data);

                // Set up a url on your server to execute the payment
                var EXECUTE_URL = "{{url_for('payment.execute')}}";

                // Set up the data you need to pass to your server
                var data = {
                    paymentID: data.paymentID,
                    payerID: data.payerID
                };
                console.log(data);
                // Make a call to your server to execute the payment
                return paypal.request.post(EXECUTE_URL, {
                    paymentID: data.paymentID,
                    payerID: data.payerID
                }).then(function (res) {
                    window.alert('Payment Complete!');
                });
            }
    }, '#paypal-button-container');
</script>

{% endblock %}
